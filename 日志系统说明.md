# 多智能体系统日志记录说明

## 概述

我们成功实现了一个结构化的多日志系统，将原来直接输出到终端的所有print信息分别存储到不同的日志文件中，便于分析和调试。

## 日志文件结构

### 1. env_agent.log
**用途**: 记录每个turn的环境和智能体相关信息

**记录内容**:
- 智能体状态更新
- 环境交互信息
- 奖励计算结果
- 轨迹信息

**格式**:
```
[时间戳] [ROLLOUT:rollout_idx] [TURN:turn_idx] [AGENT:agent_name] 结构化JSON数据
```

### 2. model.log
**用途**: 记录LLM的字符形式的prompt和response

**记录内容**:
- 模型输入提示（prompt）
- 模型生成响应（response）
- 生成参数和配置
- 错误和超时信息

**格式**:
```
[时间戳] [ROLLOUT:rollout_idx] [POLICY:policy_name] 结构化JSON数据
```

### 3. async.log
**用途**: 记录每个rollout_idx和turn的完成时间点

**记录内容**:
- Rollout开始/完成事件
- 并发任务执行状态
- 错误和异常信息
- 性能统计数据

**格式**:
```
[时间戳] [ROLLOUT:rollout_idx] 结构化JSON数据
```

## 主要功能

### 1. 安全序列化
- 自动处理OmegaConf配置对象
- 处理不可JSON序列化的对象
- 防止序列化错误导致程序崩溃

### 2. 结构化日志
- 每条日志都是JSON格式，便于解析
- 包含时间戳、上下文信息和详细数据
- 支持嵌套的额外数据字段

### 3. 分类记录
- 按功能模块分离日志
- 避免信息混杂
- 便于针对性分析

## 集成位置

### 1. MultiAgentsExecutionEngine
- 记录rollout执行流程
- 记录并发任务状态
- 记录环境和智能体交互

### 2. AsyncLLMServerManager
- 记录模型调用过程
- 记录prompt和response
- 记录生成时间和错误

### 3. Agent类（CodeGenerationAgent, UnitTestGenerationAgent）
- 记录智能体状态变化
- 记录动作和奖励计算
- 记录与环境的交互

## 使用方法

### 初始化日志系统
```python
from pettingllms.utils.logger_config import init_multi_logger

# 初始化日志系统，指定日志目录
multi_logger = init_multi_logger("logs")
```

### 记录不同类型的日志
```python
# 记录环境智能体信息
multi_logger.log_env_agent_info(
    rollout_idx=0, turn_idx=1, agent_name="code_generator",
    message="智能体更新", extra_data={"状态": "正常"}
)

# 记录模型交互
multi_logger.log_model_interaction(
    rollout_idx=0, policy_name="code_generator", 
    prompt="提示", response="响应"
)

# 记录异步事件
multi_logger.log_async_event(
    rollout_idx=0, event_type="完成", message="任务完成"
)
```

## 优势

1. **可追溯性**: 每个rollout的完整执行流程都有记录
2. **可分析性**: 结构化JSON格式便于后续分析
3. **可调试性**: 详细的错误信息和执行状态
4. **性能监控**: 时间戳信息便于性能分析
5. **模块化**: 不同类型的信息分开存储

## 注意事项

1. 日志文件会持续增长，建议定期清理或轮转
2. JSON格式的日志文件比普通文本占用更多空间
3. 确保有足够的磁盘空间存储日志
4. 可以根据需要调整日志级别和详细程度

## 故障排除

如果遇到JSON序列化错误，日志系统会自动将不可序列化的对象转换为字符串表示，确保程序不会因为日志记录而崩溃。
